name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /root/us-paper-cup
            git fetch origin
            git reset --hard origin/main
            docker-compose down
            docker-compose up -d --build
            echo "Deployment finished. Waiting for DB..."
            docker-compose exec -T web sh -c 'date > /app/public/deploy_check.txt'
            sleep 15
            echo "Applying Admin Password Fix..."
            # Force-set password to 'admin123' using hardcoded hash
            docker-compose exec -T web node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); async function main() { await prisma.user.upsert({ where: { email: 'admin@uspapercupfactory.com' }, update: { password: '\$2b\$10\$iUbSRT5127B2Odfx.jZbA.pJeYXTRxvaPuIZ8AQJxlwRRUxXgs6Ny', role: 'ADMIN' }, create: { email: 'admin@uspapercupfactory.com', name: 'Admin', password: '\$2b\$10\$iUbSRT5127B2Odfx.jZbA.pJeYXTRxvaPuIZ8AQJxlwRRUxXgs6Ny', role: 'ADMIN' } }); } main().then(() => console.log('Admin Fixed')).catch(e => console.error(e));"
