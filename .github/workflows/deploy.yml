name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /root/us-paper-cup
            git fetch origin
            git reset --hard origin/main
            echo "Auto-healing: Restarting containers..."
            docker-compose down --remove-orphans
            docker system prune -a -f
            docker-compose up -d --build
            docker image prune -f
            echo "Waiting for services to stabilize..."
            sleep 10
            echo "Auto-healing: Ensuring admin user exists..."
            # Force-copy the new script into the container (in case build failed/stale)
            WEB_CONTAINER=$(docker-compose ps -q web)
            docker cp scripts/create-admin-prod.js $WEB_CONTAINER:/app/scripts/create-admin-prod.js
            # Run the script with the fresh code
            docker-compose exec -T web node scripts/create-admin-prod.js
            echo "Auto-healing: Fixing upload permissions..."
            docker-compose exec -u root -T web chown -R nextjs:nodejs /app/public/uploads
            docker-compose exec -u root -T web chmod -R 777 /app/public/uploads
            echo "=== CONTAINER STATUS ==="
            docker ps -a
            echo "=== WEB LOGS ==="
            docker-compose logs --tail 50 web
            echo "=== CADDY LOGS ==="
            docker-compose logs --tail 20 caddy
