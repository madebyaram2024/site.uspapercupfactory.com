name: Fix Admin Only

on:
    workflow_dispatch:

jobs:
    fix-admin:
        runs-on: ubuntu-latest
        steps:
            - name: Apply Admin Fix via SSH (Raw)
              run: |
                  mkdir -p ~/.ssh/
                  echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa

                  echo "=== CONNECTING TO ${{ secrets.VPS_HOST }} ==="
                  ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "cd /root/us-paper-cup && docker-compose exec -T web node -e \"const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); const bcrypt = require('bcryptjs'); async function main() { const password = 'admin123'; const hash = await bcrypt.hash(password, 10); console.log('Generated hash for admin123'); await prisma.user.upsert({ where: { email: 'admin@uspapercupfactory.com' }, update: { password: hash, role: 'ADMIN' }, create: { email: 'admin@uspapercupfactory.com', password: hash, name: 'Admin', role: 'ADMIN' } }); console.log('Admin user updated.'); const user = await prisma.user.findUnique({ where: { email: 'admin@uspapercupfactory.com' } }); const isValid = await bcrypt.compare(password, user.password); console.log('VERIFICATION: Password admin123 matches DB hash: ' + isValid); await prisma.\$disconnect(); } main();\""
                  echo "=== FIX APPLIED ==="
