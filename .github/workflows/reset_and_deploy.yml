name: Reset and Deploy

on:
    workflow_dispatch:

jobs:
    reset-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Reset Docker and Redeploy via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      echo "=== STARTING FULL RESET ==="
                      cd /root/us-paper-cup

                      echo "Stopping all containers..."
                      docker-compose down -v --remove-orphans

                      echo "Pruning system..."
                      docker system prune -a -f

                      echo "Forcing clean code sync..."
                      git fetch --all
                      git reset --hard origin/main

                      echo "Rebuilding and Starting..."
                      docker-compose up -d --build --force-recreate

                      echo "Waiting for health..."
                      sleep 20

                      echo "=== APPLYING ADMIN FIX ==="
                      docker-compose exec -T web node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); async function main() { await prisma.user.upsert({ where: { email: 'admin@uspapercupfactory.com' }, update: { password: '\$2b\$10\$iUbSRT5127B2Odfx.jZbA.pJeYXTRxvaPuIZ8AQJxlwRRU8eKHuKXH6', role: 'ADMIN' }, create: { email: 'admin@uspapercupfactory.com', password: '\$2b\$10\$iUbSRT5127B2Odfx.jZbA.pJeYXTRxvaPuIZ8AQJxlwRRU8eKHuKXH6', name: 'Admin', role: 'ADMIN' } }); await prisma.\$disconnect(); } main();"

                      echo "=== NEW STATUS ==="
                      docker ps -a
                      docker-compose logs --tail 20 web
