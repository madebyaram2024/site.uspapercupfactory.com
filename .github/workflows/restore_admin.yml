name: Restore Admin User

on:
    push:
        paths:
            - ".github/workflows/restore_admin.yml"

jobs:
    restore-admin:
        runs-on: ubuntu-latest
        steps:
            - name: Fix Admin Password Immediately
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      echo "Applying Emergency Password Fix..."
                      # Hardcoded hash for 'admin123' generated via bcryptjs (salt 10)
                      # Hash: $2b$10$iUbSRT5127B2Odfx.jZbA.pJeYXTRxvaPuIZ8AQJxlwRRUxXgs6Ny

                      docker-compose -f /root/us-paper-cup/docker-compose.yml exec -T web node -e "
                        const { PrismaClient } = require('@prisma/client');
                        const prisma = new PrismaClient();
                        prisma.user.upsert({
                          where: { email: 'admin@uspapercupfactory.com' },
                          update: { 
                            password: '\$2b\$10\$iUbSRT5127B2Odfx.jZbA.pJeYXTRxvaPuIZ8AQJxlwRRUxXgs6Ny',
                            role: 'ADMIN'
                          },
                          create: {
                            email: 'admin@uspapercupfactory.com',
                            name: 'Admin User',
                            password: '\$2b\$10\$iUbSRT5127B2Odfx.jZbA.pJeYXTRxvaPuIZ8AQJxlwRRUxXgs6Ny',
                            role: 'ADMIN'
                          }
                        }).then(u => console.log('FIX SUCCESS: Admin Updated', u.email)).catch(e => console.error('FIX FAILURE', e));
                      "
